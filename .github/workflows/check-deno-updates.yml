name: Check deno updates

on:
  workflow_dispatch:
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * 0,2,4"

permissions: {}

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.REDIST_ICONS_UPDATE }}
          fetch-depth: 0
          persist-credentials: true # needed for git push

      - run: rustup update --no-self-update

      - name: Setup nushell
        uses: hustcer/setup-nu@985d59ec83ae3e3418f9d36471cda38b9d8b9879 # v3.20
        with:
          version: ${{ vars.NU_SHELL_VERSION || '*' }}

      - uses: denoland/setup-deno@e95548e56dfa95d4e1a28d6f422fafe75c4c26fb # v2.0.3
        with:
          cache: true
      - name: Install Deno deps
        run: deno install

      - uses: astral-sh/setup-uv@3259c6206f993105e3a61b142c2d97bf4b9ef83d # v7.1.0
      - name: Install Python deps
        run: uv sync

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: "~/.cache/pre-commit"
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Check for updates
        run: nu .github/workflows/check-deno-updates.nu
        env:
          GITHUB_TOKEN: ${{ secrets.REDIST_ICONS_UPDATE }}
